@model distribution_copy.Models.InputModel.InputModel
@{
    Layout = "~/Views/Shared/_DashBoard.cshtml";
}
@{
    ViewBag.Title = "Index";
}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
@*<div align="center">
        <label for="orgsDropdown" style="margin-top:50px;"><b>Organisations</b></label>
        <select class="form-control" id="org" name="departmentsDropdown"></select>
    </div>*@

<div class="col-md-5" style="margin-left:60px">
    <label for="orgsDropdown" style="margin-top:30px;"><b>Organisations</b></label>
    <select class="form-control" id="org" name="departmentsDropdown"></select>
    <label id="NoOrg" class="text-danger" hidden>!!!!Please Select Organisation</label>
</div>
<div align="center" style="margin-top:10px">
    <img src="~/Content/Images/loadinggif.gif" id="Load" width="150" height="150" hidden />
</div>
<div id="OrgChange" style="margin-left:30px" hidden>
    <div class="row" style="font-size:medium;margin-left:50px">
        <div class="col-4"><p id="Project"></p> </div>
        <div class=" col-4"><p id="BuildDef"></p></div>
        <div class="col-4"><p id="ReleaseDef"></p></div>
    </div>
    <div class="row" style="font-size:medium;margin-left:50px">
        <div class="col-4"><p id="Process"></p> </div>
        <div class="col-4"><p id="Repos"></p> </div>
        <div class="col-4"><p id="Users"></p> </div>
    </div>
    <div class="row" style="font-size:medium;margin-left:50px">
        <div class="col-4"><p id="WIcount" class="Wi"></p> </div>
    </div>
  
    <div class="row ">
        <div class="col-4" style="margin-left:50px" id="WItypeDrop">
            @*@Html.Label("WorkItem Type", htmlAttributes: new { @class = "", style = "padding-right:21px" })*@

            <label style="margin-top:20px;" class="WorkItemType"><b>WorkItem Type</b></label>
            @Html.DropDownListFor(model => model.WorkItemType, new SelectList(new[] { "--Workitem Types--" }), htmlAttributes: new { @class = "form-control WorkItemType", id = "WorkItemType", style = "opacity:0.8" })

            @Html.ValidationMessageFor(model => model.WorkItemType, "", new { @class = "text-danger" })
            <label id="WItypeErr" hidden="hidden" class="text-danger ">!!!!please select any workitem type </label>
        </div>
        <div class="col-4" style="font-size:large;margin-top:50px"><p id="WIcountByType" hidden="hidden"></p></div>
    </div>
    <div style="margin-top:10px;">
        <div class="col-md-5" style="margin-left:36px">
            <div id="projDrop " class="WorkItemType">
                <label style="margin-top:20px;" class=""><b>Projects</b></label>
                <select class="form-control " id="projectDrop" name="departmentsDropdown"></select>
                <p id="noProj" hidden="hidden" class="text-danger ">!!!!please select the project</p>
            </div>
        </div>
        <div id="ProjCounts" hidden="hidden" style="margin-top:20px;margin-left:35px; font-size:large;">
            <div class="row" style="margin-left:30px">
                <div class="col-4"><p id="PBuildDef"></p></div>
                <div class="col-4"><p id="PReleaseDef"></p></div>
                <div class="col-4"><p id="PUser"></p></div>
            </div>
            <div class="row" style="margin-left:30px">
                <div class="col-4"><p id="PRepo"></p></div>
                <div class="col-4"><p id="PWorkItem" hidden></p></div>
            </div>
        </div>
    </div>
</div>
<script>
    //Ajax Call to fetch Organization
    $(document).ready(function () {       
        var load = document.getElementById('Load');
        var orgchange= document.getElementById('OrgChange');
        var ProjCounts= document.getElementById('ProjCounts');       
        var wicounts = document.getElementsByClassName('WorkItemType');
        wicounts.hidden = true;
        var Org = $('#org').val();
        var ProjWICount;
        var selestedProj;
        var WIType

        $.ajax({
            type: 'get',
            dataType: 'json',
            url: '@Url.Action("AccountList","Account")',
            success: function (data) {

                var s = '<option value="0">--Choose Organisation--</option>';
                $("#org").empty();
                for (var i = 0; i < data.length; i++) {
                    s += '<option value="' + data[i].accountName + '">' + data[i].accountName + '</option>';
                }
                $("#org").append(s);
            }
        });

        function GetReport(data) {
                        orgchange.hidden = false;      
                        load.hidden = true;
                        $("#BuildDef").html("Build Definitions  : " + data.counts.buildDefCount);
                        $("#ReleaseDef").html("Release Definitions  : " + data.counts.releaseDefCount);
                        $("#Process").html("Process Templates : " + data.counts.processCount);
                        $("#Project").html("Projects : " + data.Count);
                        $("#Users").html("Users : " + data.counts.UserCount);
                        $("#Repos").html("Repositories : " + data.counts.repoCount);
                        $("#WIcount").html("WorkItems : " + data.counts.WIcountOrg);    
                        wicounts.hidden = false;
                        var s = '<option value="0">--Choose Project--</option>';
                        $("#projectDrop").empty();
                        for (var i = 0; i < data.Value.length; i++) {
                            s += '<option value="' + data.Value[i].Name + '">' + data.Value[i].Name + '</option>';
                        }
                        $("#projectDrop").append(s);
                        WIType = $('#WorkItemType').val()
                    
                        $('#projectDrop').change(function () {
                            selestedProj = $('#projectDrop').val();
                            for (var i = 0; i < data.Value.length; i++) {
                                if (data.Value[i].Name == selestedProj) {
                                    /*$("#noProj").hide(); */                                   
                                    ProjCounts.hidden = false;
                                    $("#PBuildDef").html("Build Definitions : " + data.Value[i].counts.buildDefCount);
                                    $("#PReleaseDef").html("Release Definitions : " + data.Value[i].counts.releaseDefCount);
                                    $("#PUser").html("Users : " + data.Value[i].counts.UserCount);
                                    $("#PRepo").html("Repositories : " + data.Value[i].counts.repoCount);
                                    if ($('#WorkItemType') != "0") {
                                        document.getElementById('PWorkItem').hidden=false;
                                        $("#PWorkItem").html(WIType + "s : " + ProjWICount);
                                    }
                                    else
                                         document.getElementById('PWorkItem').hidden=true;
                                }
                                else if (selestedProj == "0") {
                                    ProjCounts.hidden = true;                                 
                                    document.getElementById('noProj').hidden = false;
                                }
                            }
                        });
        }
            $('#org').change(function () {
                load.hidden = false;
                orgchange.hidden = true;
                ProjCounts.hidden = true;
                document.getElementById('WIcountByType').hidden = true;
                document.getElementById('NoOrg').hidden = true;
                Org = $('#org').val();
                if (Org == "0") {
                    document.getElementById('NoOrg').hidden = false;
                    $("#noProj").hide();
                    document.getElementById('WItypeErr').hidden=true;
                    load.hidden = true;
                }
                $.ajax({
                    type: 'get',
                    dataType: 'json',
                    data: { 'organisation': Org },
                    url: '@Url.Action("report","OrgReports")',
                    success: function (data) {
                        GetReport(data);
                    },
                    failure: function (data) {
                        if (data == null) {
                            alert("Please Select Any Organnisation");
                        }
                    }
                });

                //Fetching the Dropdown workitem types
                var inp = new Object();
                inp.OrganizationName = Org;
                if (inp.OrganizationName != null) {
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("WITypes", "Account")',
                        data: { inp },

                        success:
                            function (data) {
                                console.log(data);
                                document.getElementById("WorkItemType").innerHTML = "<option value='0' >--Select Workitem Type--</option>";
                                for (let i = 0; i < data.length; i++) {
                                    document.getElementById("WorkItemType").innerHTML += "<option value='" + data[i] + "'>" + data[i] + "</option>";
                                }
                            },
                        failure:
                            function () { alert("Something went wrong"); }
                    });
                }
                else {
                    return;
                }

            })
            //Sending type value to controller
            $('.WorkItemType').change(function () {
             Org = $('#org').val();
             WIType = $('#WorkItemType').val();

                 if (WIType == "0") {
                    document.getElementById('WItypeErr').hidden = false;
                    document.getElementById('WIcountByType').hidden = true;
                    document.getElementById('PWorkItem').hidden=true;
                    return;
                        }
                $.ajax({
                    type: 'Post',
                    dataType: 'json',
                    data: { 'organisation': Org, 'workitemtype': WIType, 'projectName': selestedProj },
                    url: '@Url.Action("report","OrgReports")',
                    success: function (data) {
                        if (WIType == "0") {
                             $("#WIcountByType").hide();
                            document.getElementById('WItypeErr').hidden=false;                        
                            document.getElementById('PWorkItem').hidden=true;
                        }
                        else {
                            document.getElementById('WIcountByType').hidden = false;
                            document.getElementById('WItypeErr').hidden=true;
                            ProjWICount = data.counts.ProjWIcountByType;
                            $("#WIcountByType").html(WIType + "s : " + data.counts.WIcountType);
                            if (selestedProj != "0") {
                                document.getElementById('PWorkItem').hidden=false;
                                $("#PWorkItem").html(WIType + "s : " + data.counts.ProjWIcountByType);
                            }
                        }
                    }
                });
            })
        })
</script>



